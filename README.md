# ETL TESTE GEO - PostgreSQL ‚Üí MySQL

Sistema de ETL (Extract, Transform, Load) para teste de migra√ß√£o de dados do PostgreSQL para MySQL com execu√ß√£o automatizada e monitoramento completo.

**üéØ PROJETO DE TESTE** - Use este projeto para testar o ETL antes de implementar em produ√ß√£o.

## üìã Sum√°rio

- [Requisitos](#requisitos)
- [Instala√ß√£o R√°pida](#instala√ß√£o-r√°pida)
- [Instala√ß√£o Detalhada](#instala√ß√£o-detalhada)
- [Configura√ß√£o de Credenciais](#configura√ß√£o-de-credenciais)
- [Agendamento Autom√°tico](#agendamento-autom√°tico)
- [Execu√ß√£o Manual](#execu√ß√£o-manual)
- [Monitoramento e Logs](#monitoramento-e-logs)
- [Solu√ß√£o de Problemas](#solu√ß√£o-de-problemas)
- [Estrutura do Projeto](#estrutura-do-projeto)
- [Comandos √öteis](#comandos-√∫teis)

## üîß Requisitos

### Sistema Operacional
- **Ubuntu 18.04+** (recomendado)
- Outras distribui√ß√µes Linux (instala√ß√£o manual)

### Software
- **Python 3.8+**
- **Oracle Instant Client** (instalado automaticamente)
- **PostgreSQL Client** (psycopg2)
- **Sudo/Root access** (apenas durante instala√ß√£o)

### Bancos de Dados
- **Oracle Database** (origem dos dados)
- **PostgreSQL Database** (destino dos dados)

## üöÄ Instala√ß√£o R√°pida

```bash
# 1. Clonar reposit√≥rio
git clone <repo-url> integracao_etl_geodata
cd integracao_etl_geodata

# 2. Executar instala√ß√£o completa
chmod +x setup.sh
./setup.sh

# 3. Configurar credenciais
cd /opt/etl_geodata
./configure_credentials.sh

# 4. Testar sistema
python test_connections.py
python main.py --dry-run
```

## üìö Instala√ß√£o Detalhada

### Fase 1: Infraestrutura

```bash
# Prepara√ß√£o
git clone <repo-url> integracao_etl_geodata
cd integracao_etl_geodata

# Executar setup (instala tudo automaticamente)
chmod +x setup.sh
./setup.sh
```

**O que o setup.sh faz:**
- ‚úÖ Verifica sistema Ubuntu e Python 3.8+
- ‚úÖ Instala depend√™ncias do sistema (libpq-dev, libaio1, etc.)
- ‚úÖ Baixa e configura Oracle Instant Client automaticamente
- ‚úÖ Cria ambiente virtual Python em `/opt/etl_geodata/venv`
- ‚úÖ Instala pacotes Python (pandas, cx_Oracle, psycopg2, etc.)
- ‚úÖ Cria estrutura de diret√≥rios (logs, backup, temp, sql_scripts)
- ‚úÖ Configura logrotate para gerenciamento de logs
- ‚úÖ Cria script de agendamento (`etl_cron.sh`)
- ‚úÖ Copia arquivos do projeto para `/opt/etl_geodata/`

### Fase 2: Credenciais

```bash
# Navegar para diret√≥rio do projeto
cd /opt/etl_geodata

# Configurar credenciais interativamente
./configure_credentials.sh
```

**O que o configure_credentials.sh faz:**
- üîí Coleta credenciais Oracle e PostgreSQL de forma segura
- üß™ Testa conex√µes antes de salvar
- üìù Cria arquivo `.env` com permiss√µes 600
- ‚úÖ Valida configura√ß√µes finais

## üîê Configura√ß√£o de Credenciais

### Credenciais Necess√°rias

**Oracle Database (Origem):**
- Host/IP do servidor
- Porta (padr√£o: 1521)
- Service Name
- Usu√°rio
- Senha

**PostgreSQL Database (Destino):**
- Host/IP do servidor
- Porta (padr√£o: 5432)
- Nome do database
- Usu√°rio
- Senha

### Processo Interativo

```bash
./configure_credentials.sh
```

**Exemplo de execu√ß√£o:**
```
üîí CONFIGURA√á√ÉO DE CREDENCIAIS
==================================

üöÄ COMO USAR:
   1. Para cada pergunta, voc√™ ver√° um valor padr√£o em [amarelo]
   2. Pressione ENTER para aceitar o padr√£o
   3. Ou digite um novo valor para substituir
   4. As senhas ficar√£o ocultas quando digitadas

üìä CONFIGURA√á√ïES ORACLE (Banco de Origem)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Host/IP do servidor Oracle [192.168.10.243]: 
Porta do Oracle [1521]: 
Service Name [ORCL]: 
Usu√°rio Oracle [GEODATA]: 
Senha Oracle: ********

üß™ Testando conex√£o Oracle...
‚úÖ Conex√£o Oracle OK!
üìÖ Data/hora do servidor: 2024-08-25 10:30:45

üêò CONFIGURA√á√ïES POSTGRESQL (Banco de Destino)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Host/IP do servidor PostgreSQL [localhost]: 
Porta do PostgreSQL [5432]: 
Nome do database [postgres]: 
Usu√°rio PostgreSQL [postgres]: 
Senha PostgreSQL: ********

üß™ Testando conex√£o PostgreSQL...
‚úÖ Conex√£o PostgreSQL OK!
üìÖ Data/hora do servidor: 2024-08-25 10:30:47

üìù Criando arquivo de configura√ß√£o .env...
‚úÖ Arquivo .env criado com sucesso!
üîí Permiss√µes restritivas aplicadas (600)

üéâ CONFIGURA√á√ÉO CONCLU√çDA COM SUCESSO!
```

### Configura√ß√£o Manual (Alternativa)

```bash
# Copiar template
cp .env.example .env

# Editar arquivo
nano .env

# Aplicar permiss√µes restritivas
chmod 600 .env
```

## ‚è∞ Agendamento Autom√°tico

### Como Funciona

O sistema usa **cron** (agendador Linux) + **etl_cron.sh** (script wrapper):

```
Cron ‚Üí etl_cron.sh ‚Üí main.py ‚Üí Logs
```

### Configurar Agendamento

```bash
# 1. Testar script wrapper
cd /opt/etl_geodata
./etl_cron.sh

# 2. Verificar logs do teste
tail -f logs/cron.log
tail -f logs/etl_geodata.log

# 3. Configurar cron
crontab -e

# 4. Adicionar linha de agendamento (escolha uma):
0 2 * * *     /opt/etl_geodata/etl_cron.sh    # Diariamente √†s 02:00
0 */6 * * *   /opt/etl_geodata/etl_cron.sh    # A cada 6 horas  
30 1 * * 1    /opt/etl_geodata/etl_cron.sh    # Segundas √†s 01:30
0 0 1 * *     /opt/etl_geodata/etl_cron.sh    # 1¬∫ dia do m√™s √† meia-noite

# 5. Salvar e sair (Ctrl+X ‚Üí Y ‚Üí Enter no nano)
```

### Verificar Agendamento

```bash
# Ver agendamentos ativos
crontab -l

# Testar cron manualmente
sudo service cron restart
sudo service cron status
```

### Formatos de Agendamento Cron

```bash
# Formato: minuto hora dia m√™s dia_semana comando
#          ‚îå‚îÄ‚îÄ‚îÄ minuto (0-59)
#          ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ hora (0-23)
#          ‚îÇ ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ dia do m√™s (1-31)
#          ‚îÇ ‚îÇ ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ m√™s (1-12)
#          ‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ dia da semana (0-7, 0/7 = domingo)
#          ‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îÇ
#          * * * * *  comando

# Exemplos pr√°ticos:
0 2 * * *      # Todo dia √†s 02:00
0 */4 * * *    # A cada 4 horas
30 8 * * 1-5   # Dias √∫teis √†s 08:30
0 0 1 * *      # Todo dia 1¬∫ do m√™s √† meia-noite
0 6 * * 0      # Domingos √†s 06:00
```

## ‚ñ∂Ô∏è Execu√ß√£o Manual

### Teste de Conex√µes

```bash
cd /opt/etl_geodata
source venv/bin/activate
python test_connections.py
```

### Valida√ß√£o Pr√©via (Dry Run)

```bash
# Validar arquivos SQL sem executar
python main.py --dry-run
```

### Testar Arquivo Espec√≠fico

```bash
# Processar apenas um arquivo SQL
python main.py --file nome_do_arquivo.sql
```

### Execu√ß√£o Completa

```bash
# Executar ETL completo
python main.py
```

### Execu√ß√£o com Logs Detalhados

```bash
# Ver logs em tempo real
python main.py & tail -f logs/etl_geodata.log
```

## üìä Monitoramento e Logs

### Arquivos de Log

```bash
# Log principal do ETL
tail -f logs/etl_geodata.log

# Log das execu√ß√µes via cron
tail -f logs/cron.log

# Hist√≥rico de execu√ß√µes
tail -f logs/cron_history.log
```

### Monitoramento em Tempo Real

```bash
# Acompanhar execu√ß√£o atual
watch -n 2 "tail -10 /opt/etl_geodata/logs/etl_geodata.log"

# Ver estat√≠sticas do sistema
htop

# Verificar uso de disco
df -h /opt/etl_geodata/
```

### Rota√ß√£o de Logs

O sistema usa **logrotate** configurado automaticamente:
- üìÖ Rota√ß√£o di√°ria
- üì¶ Compress√£o autom√°tica  
- üóÑÔ∏è Mant√©m 30 dias de hist√≥rico
- üßπ Remove logs vazios automaticamente

### Localiza√ß√£o dos Logs

```bash
/opt/etl_geodata/logs/
‚îú‚îÄ‚îÄ etl_geodata.log         # Log principal (atual)
‚îú‚îÄ‚îÄ etl_geodata.log.1       # Log do dia anterior
‚îú‚îÄ‚îÄ etl_geodata.log.2.gz    # Logs mais antigos (comprimidos)
‚îú‚îÄ‚îÄ cron.log                # Sa√≠da das execu√ß√µes via cron
‚îî‚îÄ‚îÄ cron_history.log        # Hist√≥rico simples de execu√ß√µes
```

## üîß Solu√ß√£o de Problemas

### Erro: "M√≥dulo cx_Oracle n√£o encontrado"

```bash
# Verificar ambiente virtual
cd /opt/etl_geodata
source venv/bin/activate
pip list | grep cx-Oracle

# Reinstalar se necess√°rio
pip install cx_Oracle>=8.3.0

# Verificar Oracle Client
export LD_LIBRARY_PATH="/opt/oracle/instantclient_19_1:$LD_LIBRARY_PATH"
python -c "import cx_Oracle; print('OK')"
```

### Erro: "Arquivo .env n√£o encontrado"

```bash
# Executar configura√ß√£o de credenciais
cd /opt/etl_geodata
./configure_credentials.sh

# Ou criar manualmente
cp .env.example .env
nano .env
chmod 600 .env
```

### Erro: "Falha na conex√£o Oracle"

```bash
# Testar Oracle Client
/opt/oracle/instantclient_19_1/sqlplus -v

# Verificar vari√°veis de ambiente
echo $ORACLE_HOME
echo $LD_LIBRARY_PATH

# Reconfigurar se necess√°rio
source ~/.bashrc
```

### Erro: "Permission denied" no cron

```bash
# Verificar permiss√µes do script
chmod +x /opt/etl_geodata/etl_cron.sh

# Verificar propriedade dos arquivos
sudo chown -R $USER:$USER /opt/etl_geodata/
```

### Logs n√£o aparecem no cron

```bash
# Verificar se cron est√° rodando
sudo service cron status

# Verificar logs do sistema cron
sudo tail -f /var/log/cron

# Testar script manualmente
/opt/etl_geodata/etl_cron.sh
```

### ETL travando ou ficando lento

```bash
# Verificar processos Python rodando
ps aux | grep python

# Monitorar recursos
htop

# Verificar locks no banco
# (consultas espec√≠ficas para Oracle/PostgreSQL)

# Ajustar configura√ß√µes no .env
nano .env
# ETL_BATCH_SIZE=500  (reduzir se necess√°rio)
# ETL_QUERY_TIMEOUT=600  (aumentar se necess√°rio)
```

## üìÅ Estrutura do Projeto

```
/opt/etl_geodata/
‚îú‚îÄ‚îÄ main.py                     # Script principal do ETL
‚îú‚îÄ‚îÄ config.py                   # Configura√ß√µes e valida√ß√µes
‚îú‚îÄ‚îÄ etl_functions.py            # Fun√ß√µes do ETL
‚îú‚îÄ‚îÄ test_connections.py         # Teste de conex√µes
‚îú‚îÄ‚îÄ configure_credentials.sh    # Configura√ß√£o interativa
‚îú‚îÄ‚îÄ configure_credentials_simple.sh  # Vers√£o sem testes
‚îú‚îÄ‚îÄ etl_cron.sh                # Script para cron
‚îú‚îÄ‚îÄ .env                       # Credenciais (criado ap√≥s config)
‚îú‚îÄ‚îÄ .env.backup               # Backup autom√°tico do .env
‚îú‚îÄ‚îÄ requirements.txt          # Depend√™ncias Python
‚îú‚îÄ‚îÄ venv/                     # Ambiente virtual Python
‚îú‚îÄ‚îÄ logs/                     # Todos os arquivos de log
‚îÇ   ‚îú‚îÄ‚îÄ etl_geodata.log
‚îÇ   ‚îú‚îÄ‚îÄ cron.log
‚îÇ   ‚îî‚îÄ‚îÄ cron_history.log
‚îú‚îÄ‚îÄ backup/                   # Backups de dados
‚îú‚îÄ‚îÄ temp/                     # Arquivos tempor√°rios
‚îî‚îÄ‚îÄ sql_scripts/             # Scripts SQL para ETL
    ‚îú‚îÄ‚îÄ tabela1.sql
    ‚îú‚îÄ‚îÄ tabela2.sql
    ‚îî‚îÄ‚îÄ ...
```

## üõ†Ô∏è Comandos √öteis

### Navega√ß√£o e Ativa√ß√£o

```bash
# Ir para diret√≥rio do projeto
cd /opt/etl_geodata

# Ativar ambiente virtual
source venv/bin/activate

# Desativar ambiente virtual
deactivate
```

### Execu√ß√£o e Teste

```bash
# Teste de conex√µes
python test_connections.py

# ETL completo
python main.py

# Modo dry-run (apenas valida√ß√£o)
python main.py --dry-run

# Processar arquivo espec√≠fico
python main.py --file arquivo.sql

# Executar via wrapper (como no cron)
./etl_cron.sh
```

### Monitoramento

```bash
# Logs em tempo real
tail -f logs/etl_geodata.log

# √öltimas 50 linhas do log
tail -50 logs/etl_geodata.log

# Buscar erros nos logs
grep -i error logs/etl_geodata.log

# Ver execu√ß√µes do cron
tail -f logs/cron_history.log

# Estat√≠sticas de arquivos
ls -la sql_scripts/
wc -l sql_scripts/*.sql
```

### Gerenciamento

```bash
# Ver agendamentos cron
crontab -l

# Editar agendamentos
crontab -e

# Reconfigurar credenciais
./configure_credentials.sh

# Atualizar depend√™ncias
pip install -r requirements.txt --upgrade

# Verificar espa√ßo em disco
df -h /opt/etl_geodata/
du -sh /opt/etl_geodata/logs/
```

### Backup e Manuten√ß√£o

```bash
# Backup das configura√ß√µes
cp .env .env.backup.$(date +%Y%m%d)

# Limpar logs antigos manualmente
find logs/ -name "*.log.*" -mtime +30 -delete

# Verificar integridade do sistema
python -c "from config import validate_config; print('Erros:', validate_config())"

# Restart completo do cron
sudo service cron restart
```

## üìû Suporte

### Logs para An√°lise
Quando reportar problemas, inclua:

```bash
# Informa√ß√µes do sistema
cat /etc/os-release
python3 --version
/opt/oracle/instantclient_19_1/sqlplus -v

# Status do ambiente
cd /opt/etl_geodata
python -c "from config import validate_config; print(validate_config())"

# √öltimos logs
tail -100 logs/etl_geodata.log
```

### Arquivos Importantes
- `logs/etl_geodata.log` - Log principal
- `.env` - Configura√ß√µes (‚ö†Ô∏è **remover senhas** antes de compartilhar)
- `crontab -l` - Agendamentos ativos

---

## üîí Seguran√ßa

‚ö†Ô∏è **IMPORTANTE:** 
- Nunca compartilhe o arquivo `.env` (cont√©m senhas)
- Mantenha permiss√µes 600 no arquivo `.env`
- Use usu√°rios de banco com privil√©gios m√≠nimos necess√°rios
- Monitore logs regularmente para atividades suspeitas

Para mais detalhes de seguran√ßa, consulte: [`SECURITY.md`](SECURITY.md)

---

**üöÄ Sistema ETL GEODATA - Pronto para Produ√ß√£o!**